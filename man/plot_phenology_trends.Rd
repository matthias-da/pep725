% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/plot_phenology_trends.R
\name{plot_phenology_trends}
\alias{plot_phenology_trends}
\title{Plot Robust Phenological Trends With GISS-Based Climate Forcing}
\usage{
plot_phenology_trends(
  pep,
  genus_name = NULL,
  species_name = NULL,
  subspecies_name = NULL,
  phases = c(65, 87),
  common_stations = TRUE,
  combine_regions = FALSE,
  combine_layout = c("vertical", "horizontal"),
  years = 1961:2024,
  calib_years = 1991:2020,
  pred_years = NULL,
  subregions = c("Austria", "Germany-North", "Germany-South", "Switzerland"),
  giss_data = giss,
  layout = c("country_phase", "phase_country"),
  title = NULL
)
}
\arguments{
\item{pep}{A PEP725-style data frame with columns \code{year}, \code{DOY},
\code{phase_id}, \code{country}, \code{s_id}, \code{genus}, \code{species}.}

\item{genus_name}{Character string specifying a genus to filter (optional).}

\item{species_name}{Character string specifying a species to filter (optional).
If both genus and species are provided, the species filter is applied last.}

\item{phases}{Integer vector of phenological phase IDs to include
(default: \code{c(65, 87)} for flowering and maturity of fruit).}

\item{years}{Numeric vector of years to include in the analysis.
Default is \code{1961:2024}.}

\item{calib_years}{Numeric vector specifying the calibration window for robust
regression (default: \code{1991:2020}).}

\item{pred_years}{Numeric vector of years for projecting future phenology.
Default is \code{1990:2090}.}

\item{subregions}{Character vector of country names to include
(default: DACH region).}

\item{giss_data}{A data frame with at least \code{year} and either \code{Tgl}
(absolute temperature) or \code{dT} (anomaly). If \code{dT} is supplied,
the function automatically constructs \code{Tgl = dT + 14}.}

\item{layout}{Either \code{"country_phase"} (default) or \code{"phase_country"}
to control facet arrangement.}

\item{title}{Optional plot title. If \code{NULL}, the function generates one
from genus and species information.}

\item{common_ids}{Logical. If \code{TRUE} (default), only stations with observations
for all selected phases are included. If \code{FALSE}, all stations with any of the selected phases are included.}
}
\value{
A \code{ggplot} object.
}
\description{
This function visualizes long-term phenological trends for one genus or species,
using robust MM-regression (\code{robustbase::lmrob}) applied to mean annual DOYs.
Phenological observations are merged with global mean temperature anomalies
from NASA GISS to compute climate-driven trends using the model:
\deqn{DOY = a + b \cdot T_{\mathrm{gl}}}
where \eqn{T_{\mathrm{gl}}} is the global mean surface temperature
(absolute temperature reconstructed as anomaly + 14°C).
}
\details{
The function produces a faceted panel plot showing:
\itemize{
\item annual mean DOY and interquartile range,
\item robust trend lines for past and future periods,
\item CTRL (1991–2020) and PGW (2066–2095) climate windows,
\item optional layouts (country × phase or phase × country).
}

The function performs the following steps:
\enumerate{
\item Filter PEP data by species, phases, regions, years.
\item Aggregate DOYs by year–country–phase.
\item Merge with GISS global temperature anomalies.
\item Fit robust regression \eqn{DOY ~ Tgl} over the calibration window.
\item Predict past and future trends using historical and PGW-temperature.
\item Draw ribbon (IQR), annual means, trend lines, climate windows.
\item Facet by country or by phase.
}

The robust regression uses \code{robustbase::lmrob}, which is resistant to
outliers and non-normality, and therefore ideal for phenological time series.
}
\examples{
\dontrun{
# Load PEP and prepare DOY
pep <- pep_download()
colnames(pep)[colnames(pep) == "day"] <- "DOY"

# Apple (Malus domestica), phases BBCH 65 & 87, DACH only:
plot_phenology_trends(
  pep,
  species_name = "Malus domestica",
  phases = c(65, 87),
  layout = "country_phase"
)

# Same data, but facets flipped:
plot_phenology_trends(
  pep,
  species_name = "Malus domestica",
  phases = c(65, 87),
  layout = "phase_country"
)

# Genus-level plot (all species of the genus Malus)
plot_phenology_trends(
  pep,
  genus_name = "Malus",
  phases = c(65, 87)
)

# With custom phases (e.g., leaf unfolding & senescence)
plot_phenology_trends(
  pep,
  species_name = "Fagus sylvatica",
  phases = c(11, 95)
)

# Limiting countries of interest
plot_phenology_trends(
  pep,
  species_name = "Malus domestica",
  subregions = c("Austria", "Switzerland")
)

# subspecies (error, should be!)
plot_phenology_trends(
  pep,
  subspecies_name = "Malus domestica Boskoop"
)

# subspecies (now without common_species)
plot_phenology_trends(
  pep,
  subspecies_name = "Malus domestica Boskoop",
  common_stations = FALSE
)

# subspecies (now without common_species)
plot_phenology_trends(
  pep,
  subspecies_name = "Malus domestica Golden Delicious",
  common_stations = FALSE
)

}
}
\author{
Matthias Templ
}
